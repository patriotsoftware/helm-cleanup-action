name: 'Helm Cleanup'
author: DevOps
description: Run repository helm cleanup

inputs:
  namespace:
    description: 'Helm Namespace'
    required: true  
  aws-access-key-id:
    description: 'AWS Access Key ID'
    required: true
  aws-secret-access-key:
    description: 'AWS Secret Access Key'
    required: true
  github-repo-name:
    description: 'GitHub repo name'
    required: false
    default: ''
  slack-token:
    description: 'Slack token'
    required: false
    default: ''
  destination:
    description: 'Destination for messaging. Comma separated list. Valid Options: committer, #channel-name, email@email.com. Default is #alerts-devops'
    required: false
    default: '#alerts-devops'
    
runs:
  using: 'composite'
  steps:
    - name: Authenticate with DEV
      uses: aws-actions/configure-aws-credentials@v1-node16
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: us-east-1
          
    - name: Clean Up Helm
      id: helm-uninstall
      run: |
        namespace="${{ inputs.namespace }}"
        echo "main-uninstalled=true" >> $GITHUB_OUTPUT 
        results_array=$(kubectl get pods --no-headers -o custom-columns=":metadata.name" -n $namespace)
        pods=(`echo ${results_array}`);

        for i in "${pods[@]}"
        do
          value=$(kubectl get pods $i --no-headers -n $namespace)
          if [[ ${value} != *"Running"* ]] && [[ ${value} != *"Terminating"* ]]; then
            # helm name is retrieved by excluding everything after second to last dash:
            echo "POD STATUS: ${value}"
            HELM_NAME=$(echo $i | sed 's/\-[^-]*$//' | sed 's/\-[^-]*$//')
            if [ $HELM_NAME -eq $namespace ]; then
              echo "Main branch is being uninstalled. Alert is triggered."
              echo "main-uninstalled=true" >> $GITHUB_OUTPUT 
            fi
            
            echo "Uninstall HELM: ${HELM_NAME}"
            #helm uninstall $HELM_NAME -n $namespace
          fi
        done
      shell: bash

    - uses: patriotsoftware/slack-bot-action@v1
      if: ${{ steps.helm-uninstall.outputs.main-uninstalled == 'true' && inputs.slack-token != '' }}
      with:
        destination: ${{ inputs.destination }}
        # Fallback used if can't find email of committer, often due to the private github commit email addresses.
        # TODO: Change to your team's alerts channel here:
        fallback-destination: "#alerts-unknown-team"
        message: |
          *Status: Branch Cleanup Uninstalled Main/Master*
          Repo: SynergyDataSystems/${{ inputs.github-repo-name }}
          Branch Cleanup uninstalls branches that are not in a 'Running' or 'Terminating' state.
          https://github.com/SynergyDataSystems/${{ inputs.github-repo-name }}/actions/workflows/cleanup-bad-deploys.yml
        slack-token: ${{ inputs.slack-token }}
